{"version":3,"sources":["/Users/lixianjie/project/openSource/hooks/src/ui/useMeasure/useMeasure.ts"],"sourcesContent":["import { RefObject, useEffect, useRef, useState } from \"react\";\nimport ResizeObserver from \"resize-observer-polyfill\";\nimport debounce from \"lodash/debounce\";\nimport { getRefDomOrDom, useFn, useIsUnmountState } from \"@m78/hooks\";\n\nexport interface UseMeasureBound extends Omit<DOMRectReadOnly, \"toJSON\"> {\n  /** entry.contentRect中的宽高为contentSize, 所以额外提供此项 */\n  offsetHeight: number;\n  /** entry.contentRect中的宽高为contentSize, 所以额外提供此项 */\n  offsetWidth: number;\n}\n\n/**\n * 实时测量一个元素的尺寸\n * @param target - 目标节点\n * @param debounceDelay - 延迟设置的时间, 对于变更频繁的节点可以通过此项提升性能\n * @return\n *  - return[0] - 元素的尺寸, 位置等信息\n *  - return[1] - 用于直接绑定的ref\n * */\nexport function useMeasure<T extends Element = HTMLElement>(\n  target?: HTMLElement | RefObject<HTMLElement>,\n  debounceDelay?: number\n) {\n  const ref = useRef<T>(null!);\n\n  const isUnmount = useIsUnmountState();\n\n  const [bounds, set] = useState<UseMeasureBound>({\n    left: 0,\n    top: 0,\n    width: 0,\n    height: 0,\n    x: 0,\n    y: 0,\n    right: 0,\n    bottom: 0,\n    offsetHeight: 0,\n    offsetWidth: 0,\n  });\n\n  const cb = useFn(\n    ([entry]) => {\n      const rect = entry.contentRect;\n      !isUnmount() &&\n        set({\n          // rect属性不可遍历, 所以这里用蠢一点的办法逐个复制\n          left: rect.left,\n          top: rect.top,\n          width: rect.width,\n          height: rect.height,\n          x: rect.x,\n          y: rect.y,\n          right: rect.right,\n          bottom: rect.bottom,\n          offsetHeight: (entry.target as HTMLElement).offsetHeight,\n          offsetWidth: (entry.target as HTMLElement).offsetWidth,\n        });\n    },\n    (fn) => {\n      if (debounceDelay) {\n        return debounce(fn, debounceDelay);\n      }\n      return fn;\n    },\n    [debounceDelay]\n  );\n\n  const [ro] = useState(() => new ResizeObserver(cb));\n\n  function getEl() {\n    const el = getRefDomOrDom(target);\n    if (el) return el;\n    return ref.current;\n  }\n\n  useEffect(() => {\n    const el = getEl();\n\n    if (el) ro.observe(el);\n    return () => ro.disconnect();\n  }, []);\n\n  return [bounds as UseMeasureBound, ref] as const;\n}\n"],"names":["useEffect","useRef","useState","ResizeObserver","debounce","getRefDomOrDom","useFn","useIsUnmountState","useMeasure","target","debounceDelay","getEl","el","ref","current","isUnmount","left","top","width","height","x","y","right","bottom","offsetHeight","offsetWidth","bounds","set","cb","entry","rect","contentRect","fn","ro","observe","disconnect"],"mappings":"AAAA;AAAA,SAAoBA,SAAS,EAAEC,MAAM,EAAEC,QAAQ,QAAQ,OAAO,CAAC;AAC/D,OAAOC,cAAc,MAAM,0BAA0B,CAAC;AACtD,OAAOC,QAAQ,MAAM,iBAAiB,CAAC;AACvC,SAASC,cAAc,EAAEC,KAAK,EAAEC,iBAAiB,QAAQ,YAAY,CAAC;AAStE;;;;;;;GAOG,GACH,OAAO,SAASC,UAAU,CACxBC,MAA6C,EAC7CC,aAAsB,EACtB;QA+CSC,KAAK,GAAd,SAASA,KAAK,GAAG;QACf,IAAMC,EAAE,GAAGP,cAAc,CAACI,MAAM,CAAC,AAAC;QAClC,IAAIG,EAAE,EAAE,OAAOA,EAAE,CAAC;QAClB,OAAOC,GAAG,CAACC,OAAO,CAAC;IACrB,CAAC;IAlDD,IAAMD,GAAG,GAAGZ,MAAM,CAAI,IAAI,CAAE,AAAC;IAE7B,IAAMc,SAAS,GAAGR,iBAAiB,EAAE,AAAC;IAEtC,IAAsBL,IAWpB,oBAXoBA,QAAQ,CAAkB;QAC9Cc,IAAI,EAAE,CAAC;QACPC,GAAG,EAAE,CAAC;QACNC,KAAK,EAAE,CAAC;QACRC,MAAM,EAAE,CAAC;QACTC,CAAC,EAAE,CAAC;QACJC,CAAC,EAAE,CAAC;QACJC,KAAK,EAAE,CAAC;QACRC,MAAM,EAAE,CAAC;QACTC,YAAY,EAAE,CAAC;QACfC,WAAW,EAAE,CAAC;KACf,CAAC,IAAA,EAXKC,MAAM,GAASxB,IAWpB,GAXW,EAAEyB,GAAG,GAAIzB,IAWpB,GAXgB,AAWf;IAEH,IAAM0B,EAAE,GAAGtB,KAAK,CACd,gBAAa;iDAAXuB,KAAK,YAAA;QACL,IAAMC,IAAI,GAAGD,KAAK,CAACE,WAAW,AAAC;QAC/B,CAAChB,SAAS,EAAE,IACVY,GAAG,CAAC;YACF,8BAA8B;YAC9BX,IAAI,EAAEc,IAAI,CAACd,IAAI;YACfC,GAAG,EAAEa,IAAI,CAACb,GAAG;YACbC,KAAK,EAAEY,IAAI,CAACZ,KAAK;YACjBC,MAAM,EAAEW,IAAI,CAACX,MAAM;YACnBC,CAAC,EAAEU,IAAI,CAACV,CAAC;YACTC,CAAC,EAAES,IAAI,CAACT,CAAC;YACTC,KAAK,EAAEQ,IAAI,CAACR,KAAK;YACjBC,MAAM,EAAEO,IAAI,CAACP,MAAM;YACnBC,YAAY,EAAE,AAACK,KAAK,CAACpB,MAAM,CAAiBe,YAAY;YACxDC,WAAW,EAAE,AAACI,KAAK,CAACpB,MAAM,CAAiBgB,WAAW;SACvD,CAAC,CAAC;IACP,CAAC,EACD,SAACO,EAAE,EAAK;QACN,IAAItB,aAAa,EAAE;YACjB,OAAON,QAAQ,CAAC4B,EAAE,EAAEtB,aAAa,CAAC,CAAC;QACrC,CAAC;QACD,OAAOsB,EAAE,CAAC;IACZ,CAAC,EACD;QAACtB,aAAa;KAAC,CAChB,AAAC;IAEF,IAAaR,IAAsC,oBAAtCA,QAAQ,CAAC;eAAM,IAAIC,cAAc,CAACyB,EAAE,CAAC;KAAA,CAAC,IAAA,EAA5CK,EAAE,GAAI/B,IAAsC,GAA1C,AAA2C;IAQpDF,SAAS,CAAC,WAAM;QACd,IAAMY,EAAE,GAAGD,KAAK,EAAE,AAAC;QAEnB,IAAIC,EAAE,EAAEqB,EAAE,CAACC,OAAO,CAACtB,EAAE,CAAC,CAAC;QACvB,OAAO;mBAAMqB,EAAE,CAACE,UAAU,EAAE;SAAA,CAAC;IAC/B,CAAC,EAAE,EAAE,CAAC,CAAC;IAEP,OAAO;QAACT,MAAM;QAAqBb,GAAG;KAAC,CAAU;AACnD,CAAC"}