{"version":3,"sources":["/Users/lixianjie/project/openSource/hooks/src/ui/useMeasure/useMeasure.ts"],"sourcesContent":["import { RefObject, useEffect, useRef, useState } from \"react\";\nimport ResizeObserver from \"resize-observer-polyfill\";\nimport debounce from \"lodash/debounce\";\nimport { getRefDomOrDom, useFn, useIsUnmountState } from \"@m78/hooks\";\n\nexport interface UseMeasureBound extends Omit<DOMRectReadOnly, \"toJSON\"> {\n  /** entry.contentRect中的宽高为contentSize, 所以额外提供此项 */\n  offsetHeight: number;\n  /** entry.contentRect中的宽高为contentSize, 所以额外提供此项 */\n  offsetWidth: number;\n}\n\n/**\n * 实时测量一个元素的尺寸\n * @param target - 目标节点\n * @param debounceDelay - 延迟设置的时间, 对于变更频繁的节点可以通过此项提升性能\n * @return\n *  - return[0] - 元素的尺寸, 位置等信息\n *  - return[1] - 用于直接绑定的ref\n * */\nexport function useMeasure<T extends Element = HTMLElement>(\n  target?: HTMLElement | RefObject<HTMLElement>,\n  debounceDelay?: number\n) {\n  const ref = useRef<T>(null!);\n\n  const isUnmount = useIsUnmountState();\n\n  const [bounds, set] = useState<UseMeasureBound>({\n    left: 0,\n    top: 0,\n    width: 0,\n    height: 0,\n    x: 0,\n    y: 0,\n    right: 0,\n    bottom: 0,\n    offsetHeight: 0,\n    offsetWidth: 0,\n  });\n\n  const cb = useFn(\n    ([entry]) => {\n      const rect = entry.contentRect;\n      !isUnmount() &&\n        set({\n          // rect属性不可遍历, 所以这里用蠢一点的办法逐个复制\n          left: rect.left,\n          top: rect.top,\n          width: rect.width,\n          height: rect.height,\n          x: rect.x,\n          y: rect.y,\n          right: rect.right,\n          bottom: rect.bottom,\n          offsetHeight: (entry.target as HTMLElement).offsetHeight,\n          offsetWidth: (entry.target as HTMLElement).offsetWidth,\n        });\n    },\n    (fn) => {\n      if (debounceDelay) {\n        return debounce(fn, debounceDelay);\n      }\n      return fn;\n    },\n    [debounceDelay]\n  );\n\n  const [ro] = useState(() => new ResizeObserver(cb));\n\n  function getEl() {\n    const el = getRefDomOrDom(target);\n    if (el) return el;\n    return ref.current;\n  }\n\n  useEffect(() => {\n    const el = getEl();\n\n    if (el) ro.observe(el);\n    return () => ro.disconnect();\n  }, []);\n\n  return [bounds as UseMeasureBound, ref] as const;\n}\n"],"names":["useMeasure","target","debounceDelay","getEl","el","getRefDomOrDom","ref","current","useRef","isUnmount","useIsUnmountState","useState","left","top","width","height","x","y","right","bottom","offsetHeight","offsetWidth","bounds","set","cb","useFn","entry","rect","contentRect","fn","debounce","ResizeObserver","ro","useEffect","observe","disconnect"],"mappings":"AAAA;+MAAuD,OAAO,WACnC,0BAA0B,WAChC,iBAAiB,WACmB,YAAY;;;;;QAHd,OAAO;QACnC,0BAA0B;QAChC,iBAAiB;QACmB,YAAY;;;;;;;;mCAiBrDA,YAAU;;;mBAAVA,UAAU;;;;;;;IAAnB,SAASA,UAAU,CACxBC,MAA6C,EAC7CC,aAAsB,EACtB;YA+CSC,KAAK,GAAd,SAASA,KAAK,GAAG;YACf,IAAMC,EAAE,GAAGC,IAAAA,MAAc,eAAA,EAACJ,MAAM,CAAC,AAAC;YAClC,IAAIG,EAAE,EAAE,OAAOA,EAAE,CAAC;YAClB,OAAOE,GAAG,CAACC,OAAO,CAAC;QACrB,CAAC;QAlDD,IAAMD,GAAG,GAAGE,IAAAA,MAAM,OAAA,EAAI,IAAI,CAAE,AAAC;QAE7B,IAAMC,SAAS,GAAGC,IAAAA,MAAiB,kBAAA,GAAE,AAAC;QAEtC,IAAsBC,IAWpB,kBAXoBA,IAAAA,MAAQ,SAAA,EAAkB;YAC9CC,IAAI,EAAE,CAAC;YACPC,GAAG,EAAE,CAAC;YACNC,KAAK,EAAE,CAAC;YACRC,MAAM,EAAE,CAAC;YACTC,CAAC,EAAE,CAAC;YACJC,CAAC,EAAE,CAAC;YACJC,KAAK,EAAE,CAAC;YACRC,MAAM,EAAE,CAAC;YACTC,YAAY,EAAE,CAAC;YACfC,WAAW,EAAE,CAAC;SACf,CAAC,IAAA,EAXKC,MAAM,GAASX,IAWpB,GAXW,EAAEY,GAAG,GAAIZ,IAWpB,GAXgB,AAWf;QAEH,IAAMa,EAAE,GAAGC,IAAAA,MAAK,MAAA,EACd,gBAAa;mDAAXC,KAAK,YAAA;YACL,IAAMC,IAAI,GAAGD,KAAK,CAACE,WAAW,AAAC;YAC/B,CAACnB,SAAS,EAAE,IACVc,GAAG,CAAC;gBACF,8BAA8B;gBAC9BX,IAAI,EAAEe,IAAI,CAACf,IAAI;gBACfC,GAAG,EAAEc,IAAI,CAACd,GAAG;gBACbC,KAAK,EAAEa,IAAI,CAACb,KAAK;gBACjBC,MAAM,EAAEY,IAAI,CAACZ,MAAM;gBACnBC,CAAC,EAAEW,IAAI,CAACX,CAAC;gBACTC,CAAC,EAAEU,IAAI,CAACV,CAAC;gBACTC,KAAK,EAAES,IAAI,CAACT,KAAK;gBACjBC,MAAM,EAAEQ,IAAI,CAACR,MAAM;gBACnBC,YAAY,EAAE,AAACM,KAAK,CAACzB,MAAM,CAAiBmB,YAAY;gBACxDC,WAAW,EAAE,AAACK,KAAK,CAACzB,MAAM,CAAiBoB,WAAW;aACvD,CAAC,CAAC;QACP,CAAC,EACD,SAACQ,EAAE,EAAK;YACN,IAAI3B,aAAa,EAAE;gBACjB,OAAO4B,IAAAA,SAAQ,QAAA,EAACD,EAAE,EAAE3B,aAAa,CAAC,CAAC;YACrC,CAAC;YACD,OAAO2B,EAAE,CAAC;QACZ,CAAC,EACD;YAAC3B,aAAa;SAAC,CAChB,AAAC;QAEF,IAAaS,IAAsC,kBAAtCA,IAAAA,MAAQ,SAAA,EAAC;mBAAM,IAAIoB,uBAAc,QAAA,CAACP,EAAE,CAAC;SAAA,CAAC,IAAA,EAA5CQ,EAAE,GAAIrB,IAAsC,GAA1C,AAA2C;QAQpDsB,IAAAA,MAAS,UAAA,EAAC,WAAM;YACd,IAAM7B,EAAE,GAAGD,KAAK,EAAE,AAAC;YAEnB,IAAIC,EAAE,EAAE4B,EAAE,CAACE,OAAO,CAAC9B,EAAE,CAAC,CAAC;YACvB,OAAO;uBAAM4B,EAAE,CAACG,UAAU,EAAE;aAAA,CAAC;QAC/B,CAAC,EAAE,EAAE,CAAC,CAAC;QAEP,OAAO;YAACb,MAAM;YAAqBhB,GAAG;SAAC,CAAU;IACnD,CAAC"}