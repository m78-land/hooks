{"version":3,"sources":["/Users/lixianjie/project/openSource/hooks/src/state/useStorageState/useStorageState.ts"],"sourcesContent":["import { StateInitState, SetStateBase, useFn } from \"@m78/hooks\";\nimport { __GLOBAL__ } from \"@m78/utils\";\nimport { useState } from \"react\";\n\nexport interface UseStorageStateOptions {\n  /** 缓存类型 */\n  type?: \"local\" | \"session\";\n  /** false | 是否禁用缓存 */\n  disabled?: boolean;\n}\n\nconst BASE_KEY = \"USE_STORAGE_CACHE\";\n\nconst storagMethod = {\n  local: (__GLOBAL__ as Window).localStorage,\n  session: (__GLOBAL__ as Window).sessionStorage,\n};\n\nfunction setStorage(\n  key: string,\n  val: any,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  if (val === undefined) return;\n  const method = storagMethod[type!];\n  if (!method) return;\n  method.setItem(`${BASE_KEY}_${key.toUpperCase()}`, JSON.stringify(val));\n}\n\nfunction getStorage(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  const method = storagMethod[type!];\n  if (!method) return;\n  const cache = method.getItem(`${BASE_KEY}_${key.toUpperCase()}`);\n  return cache === null ? cache : JSON.parse(cache);\n}\n\nfunction remove(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  const method = storagMethod[type!];\n  if (!method) return;\n  method.removeItem(`${BASE_KEY}_${key.toUpperCase()}`);\n}\n\nconst defaultOptions: Required<UseStorageStateOptions> = {\n  type: \"session\",\n  disabled: false,\n};\n\nfunction useStorageBase<T = undefined>(\n  /** 缓存key */\n  key: string,\n  /** 初始状态 */\n  initState?: StateInitState<T>,\n  /** 其他选项 */\n  options?: UseStorageStateOptions\n): [T, SetStateBase<T>] {\n  const opt = {\n    ...defaultOptions,\n    ...options,\n  };\n\n  const [state, setState] = useState<T>(() => {\n    if (!opt.disabled) {\n      const cache = getStorage(key, opt.type);\n      if (cache !== null) {\n        // null以外的值都视为缓存\n        return cache;\n      }\n    }\n\n    if (initState instanceof Function) {\n      const _initState = initState();\n      !opt.disabled && setStorage(key, _initState, opt.type);\n      return _initState;\n    }\n    !opt.disabled && setStorage(key, initState, opt.type);\n    return initState;\n  });\n\n  const memoSetState: SetStateBase<T> = useFn((patch) => {\n    if (patch instanceof Function) {\n      setState((prev) => {\n        const patchRes = patch(prev);\n        !opt.disabled && setStorage(key, patchRes, opt.type);\n        return patchRes;\n      });\n    } else {\n      !opt.disabled && setStorage(key, patch, opt.type);\n      setState(patch);\n    }\n  });\n\n  return [state, memoSetState];\n}\n\nexport const useStorageState = Object.assign(useStorageBase, {\n  get: getStorage,\n  set: setStorage,\n  remove,\n});\n"],"names":["useStorageState","BASE_KEY","storagMethod","local","__GLOBAL__","localStorage","session","sessionStorage","setStorage","key","val","type","undefined","method","setItem","toUpperCase","JSON","stringify","getStorage","cache","getItem","parse","remove","removeItem","defaultOptions","disabled","useStorageBase","initState","options","opt","useState","Function","_initState","state","setState","memoSetState","useFn","patch","prev","patchRes","Object","assign","get","set"],"mappings":"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"}