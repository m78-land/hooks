{"version":3,"sources":["/Users/lixianjie/project/openSource/hooks/src/state/useFormState/useFormState.ts"],"sourcesContent":["import { useState, useRef } from \"react\";\nimport { useUpdateEffect } from \"@m78/hooks\";\nimport { isFunction, AnyObject, defer } from \"@m78/utils\";\nimport _isEqual from \"lodash/isEqual\";\n\n/**\n * 表单组件的统一接口\n * @type <T> - value类型\n * */\nexport interface FormLike<T> {\n  value?: T;\n  onChange?: (value: T) => void;\n  defaultValue?: T;\n}\n\n/**\n * 表单组件的统一接口， 包含额外参数\n * @type <T> - value类型\n * @type <Ext> - onChange接收的额外参数的类型\n * */\nexport interface FormLikeWithExtra<T, Ext = any> {\n  value?: T;\n  onChange?: (value: T, extra: Ext) => void;\n  defaultValue?: T;\n}\n\nexport interface SetFormState<T, Ext = any> {\n  (patch: T | ((prev: T) => T), extra?: Ext): void;\n}\n\nexport interface UseFormStateConfig {\n  /** 'value' | 自定义获取value的key */\n  valueKey?: string;\n  /** 'defaultValue' | 自定义获取defaultValue的key */\n  defaultValueKey?: string;\n  /** 'onChange' | 自定义onChange的key */\n  triggerKey?: string;\n  /**\n   * false | 对value执行深度对比，以支持引用类型，你只会在极少的情况下使用到此配置\n   * - 默认情况下，传入的value与上一个value全等判断成功时才会同步到本地并触发onChange，大部分时候这都没有问题，但是\n   * 如果你内联式的传入`value={[1, 2, 3]}`, 会造成每一次render都触发onChange,\n   * 此时你如果通过onChange更新状态则会造成内存泄露, 开启此项可以对引用类型的值进行深对比，从而避免这种情况\n   * - 🎉如果循正常用例，将value放到useState等hook中进行管理，是不需要开启这个配置的，因为引用只会在变更时改变\n   * - 如果value的层次结构过于复杂或者很大，不要使用此配置，因为大数据的深对比很消耗性能\n   * */\n  deep?: boolean;\n}\n\n/** 便捷的实现统一接口的受控、非受控表单组件, 也可用于任何需要受控、非受控状态的场景 */\nexport function useFormState<T, Ext = any>(\n  /** 透传消费组件的props，该组件需要实现FormLike接口 */\n  props: AnyObject,\n  /** 默认值，会被value与defaultValue覆盖 */\n  defaultValue: T,\n  /** 其他配置 */\n  config?: UseFormStateConfig\n) {\n  const {\n    valueKey = \"value\",\n    defaultValueKey = \"defaultValue\",\n    triggerKey = \"onChange\",\n    deep,\n  } = config || {};\n\n  const {\n    [valueKey]: value,\n    [triggerKey]: onChange,\n    [defaultValueKey]: propDefaultValue,\n  } = props;\n\n  // 用于在一些特定的位置能立即获取到`state\n  const stateRef = useRef<T>();\n\n  // 设置表单状态\n  const [state, setState] = useState(() => {\n    // 初始状态获取说明: value > defaultValue > useFormState中配置的defaultValue\n    let val = defaultValue;\n    if (valueKey in props) {\n      val = props[valueKey] === undefined ? defaultValue : value;\n    }\n    if (defaultValueKey in props) {\n      val =\n        props[defaultValueKey] === undefined ? defaultValue : propDefaultValue;\n    }\n\n    return (stateRef.current = val);\n  });\n\n  /* 为受控组件同步状态 */\n  useUpdateEffect(() => {\n    if (valueKey in props) {\n      if (deep) {\n        !_isEqual(value, stateRef.current) &&\n          setState((stateRef.current = value));\n      } else {\n        value !== stateRef.current && setState((stateRef.current = value));\n      }\n    }\n  }, [value]);\n\n  /* 处理修改表单值 */\n  const setFormState: SetFormState<T, Ext> = (patch, extra) => {\n    /* 是受控组件则将新值通过onChange回传即可，非受控组件设置本地状态并通过onChange通知 */\n    const hasValue = valueKey in props;\n    if (isFunction(patch)) {\n      if (!hasValue) {\n        setState((prev) => {\n          const patchResult = patch(prev);\n\n          defer(() => {\n            onChange && onChange(patchResult, extra);\n          });\n\n          return patchResult;\n        });\n      } else {\n        const patchResult = patch(stateRef.current!);\n        onChange && onChange(patchResult, extra);\n      }\n    } else {\n      onChange && onChange(patch, extra);\n      if (!hasValue) {\n        setState(patch);\n      }\n    }\n  };\n\n  return [state, setFormState] as const;\n}\n\n// 别名\nexport { useFormState as useControllableValue };\n"],"names":["useFormState","useControllableValue","props","defaultValue","config","valueKey","defaultValueKey","triggerKey","deep","value","onChange","propDefaultValue","stateRef","useRef","useState","val","undefined","current","state","setState","useUpdateEffect","_isEqual","setFormState","patch","extra","hasValue","isFunction","prev","patchResult","defer"],"mappings":"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"}