{"version":3,"sources":["/Users/lixianjie/project/openSource/hooks/src/state/useFormState/useFormState.ts"],"sourcesContent":["import { useState, useRef } from \"react\";\nimport { useUpdateEffect } from \"@m78/hooks\";\nimport { isFunction, AnyObject, defer } from \"@m78/utils\";\nimport _isEqual from \"lodash/isEqual\";\n\n/**\n * è¡¨å•ç»„ä»¶çš„ç»Ÿä¸€æ¥å£\n * @type <T> - valueç±»å‹\n * */\nexport interface FormLike<T> {\n  value?: T;\n  onChange?: (value: T) => void;\n  defaultValue?: T;\n}\n\n/**\n * è¡¨å•ç»„ä»¶çš„ç»Ÿä¸€æ¥å£ï¼Œ åŒ…å«é¢å¤–å‚æ•°\n * @type <T> - valueç±»å‹\n * @type <Ext> - onChangeæ¥æ”¶çš„é¢å¤–å‚æ•°çš„ç±»å‹\n * */\nexport interface FormLikeWithExtra<T, Ext = any> {\n  value?: T;\n  onChange?: (value: T, extra: Ext) => void;\n  defaultValue?: T;\n}\n\nexport interface SetFormState<T, Ext = any> {\n  (patch: T | ((prev: T) => T), extra?: Ext): void;\n}\n\nexport interface UseFormStateConfig {\n  /** 'value' | è‡ªå®šä¹‰è·å–valueçš„key */\n  valueKey?: string;\n  /** 'defaultValue' | è‡ªå®šä¹‰è·å–defaultValueçš„key */\n  defaultValueKey?: string;\n  /** 'onChange' | è‡ªå®šä¹‰onChangeçš„key */\n  triggerKey?: string;\n  /**\n   * false | å¯¹valueæ‰§è¡Œæ·±åº¦å¯¹æ¯”ï¼Œä»¥æ”¯æŒå¼•ç”¨ç±»å‹ï¼Œä½ åªä¼šåœ¨æå°‘çš„æƒ…å†µä¸‹ä½¿ç”¨åˆ°æ­¤é…ç½®\n   * - é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼ å…¥çš„valueä¸ä¸Šä¸€ä¸ªvalueå…¨ç­‰åˆ¤æ–­æˆåŠŸæ—¶æ‰ä¼šåŒæ­¥åˆ°æœ¬åœ°å¹¶è§¦å‘onChangeï¼Œå¤§éƒ¨åˆ†æ—¶å€™è¿™éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯\n   * å¦‚æœä½ å†…è”å¼çš„ä¼ å…¥`value={[1, 2, 3]}`, ä¼šé€ æˆæ¯ä¸€æ¬¡renderéƒ½è§¦å‘onChange,\n   * æ­¤æ—¶ä½ å¦‚æœé€šè¿‡onChangeæ›´æ–°çŠ¶æ€åˆ™ä¼šé€ æˆå†…å­˜æ³„éœ², å¼€å¯æ­¤é¡¹å¯ä»¥å¯¹å¼•ç”¨ç±»å‹çš„å€¼è¿›è¡Œæ·±å¯¹æ¯”ï¼Œä»è€Œé¿å…è¿™ç§æƒ…å†µ\n   * - ğŸ‰å¦‚æœå¾ªæ­£å¸¸ç”¨ä¾‹ï¼Œå°†valueæ”¾åˆ°useStateç­‰hookä¸­è¿›è¡Œç®¡ç†ï¼Œæ˜¯ä¸éœ€è¦å¼€å¯è¿™ä¸ªé…ç½®çš„ï¼Œå› ä¸ºå¼•ç”¨åªä¼šåœ¨å˜æ›´æ—¶æ”¹å˜\n   * - å¦‚æœvalueçš„å±‚æ¬¡ç»“æ„è¿‡äºå¤æ‚æˆ–è€…å¾ˆå¤§ï¼Œä¸è¦ä½¿ç”¨æ­¤é…ç½®ï¼Œå› ä¸ºå¤§æ•°æ®çš„æ·±å¯¹æ¯”å¾ˆæ¶ˆè€—æ€§èƒ½\n   * */\n  deep?: boolean;\n}\n\n/** ä¾¿æ·çš„å®ç°ç»Ÿä¸€æ¥å£çš„å—æ§ã€éå—æ§è¡¨å•ç»„ä»¶, ä¹Ÿå¯ç”¨äºä»»ä½•éœ€è¦å—æ§ã€éå—æ§çŠ¶æ€çš„åœºæ™¯ */\nexport function useFormState<T, Ext = any>(\n  /** é€ä¼ æ¶ˆè´¹ç»„ä»¶çš„propsï¼Œè¯¥ç»„ä»¶éœ€è¦å®ç°FormLikeæ¥å£ */\n  props: AnyObject,\n  /** é»˜è®¤å€¼ï¼Œä¼šè¢«valueä¸defaultValueè¦†ç›– */\n  defaultValue: T,\n  /** å…¶ä»–é…ç½® */\n  config?: UseFormStateConfig\n) {\n  const {\n    valueKey = \"value\",\n    defaultValueKey = \"defaultValue\",\n    triggerKey = \"onChange\",\n    deep,\n  } = config || {};\n\n  const {\n    [valueKey]: value,\n    [triggerKey]: onChange,\n    [defaultValueKey]: propDefaultValue,\n  } = props;\n\n  // ç”¨äºåœ¨ä¸€äº›ç‰¹å®šçš„ä½ç½®èƒ½ç«‹å³è·å–åˆ°`state\n  const stateRef = useRef<T>();\n\n  // è®¾ç½®è¡¨å•çŠ¶æ€\n  const [state, setState] = useState(() => {\n    // åˆå§‹çŠ¶æ€è·å–è¯´æ˜: value > defaultValue > useFormStateä¸­é…ç½®çš„defaultValue\n    let val = defaultValue;\n    if (valueKey in props) {\n      val = props[valueKey] === undefined ? defaultValue : value;\n    }\n    if (defaultValueKey in props) {\n      val =\n        props[defaultValueKey] === undefined ? defaultValue : propDefaultValue;\n    }\n\n    return (stateRef.current = val);\n  });\n\n  /* ä¸ºå—æ§ç»„ä»¶åŒæ­¥çŠ¶æ€ */\n  useUpdateEffect(() => {\n    if (valueKey in props) {\n      if (deep) {\n        !_isEqual(value, stateRef.current) &&\n          setState((stateRef.current = value));\n      } else {\n        value !== stateRef.current && setState((stateRef.current = value));\n      }\n    }\n  }, [value]);\n\n  /* å¤„ç†ä¿®æ”¹è¡¨å•å€¼ */\n  const setFormState: SetFormState<T, Ext> = (patch, extra) => {\n    /* æ˜¯å—æ§ç»„ä»¶åˆ™å°†æ–°å€¼é€šè¿‡onChangeå›ä¼ å³å¯ï¼Œéå—æ§ç»„ä»¶è®¾ç½®æœ¬åœ°çŠ¶æ€å¹¶é€šè¿‡onChangeé€šçŸ¥ */\n    const hasValue = valueKey in props;\n    if (isFunction(patch)) {\n      if (!hasValue) {\n        setState((prev) => {\n          const patchResult = patch(prev);\n\n          defer(() => {\n            onChange && onChange(patchResult, extra);\n          });\n\n          return patchResult;\n        });\n      } else {\n        const patchResult = patch(stateRef.current!);\n        onChange && onChange(patchResult, extra);\n      }\n    } else {\n      onChange && onChange(patch, extra);\n      if (!hasValue) {\n        setState(patch);\n      }\n    }\n  };\n\n  return [state, setFormState] as const;\n}\n\n// åˆ«å\nexport { useFormState as useControllableValue };\n"],"names":["useFormState","useControllableValue","props","defaultValue","config","valueKey","defaultValueKey","triggerKey","deep","value","onChange","propDefaultValue","stateRef","useRef","useState","val","undefined","current","state","setState","useUpdateEffect","_isEqual","setFormState","patch","extra","hasValue","isFunction","prev","patchResult","defer"],"mappings":"AAAA;+MAAiC,OAAO,WACR,YAAY,WACC,YAAY,WACpC,gBAAgB;;;;;QAHJ,OAAO;QACR,YAAY;QACC,YAAY;QACpC,gBAAgB;;;;;;;;;;;;;;;QA8CrBA,YAAY;mBAAZA,YAAY;;QAkFHC,oBAAoB;mBAApCD,YAAY;;;;;;IAlFd,SAASA,YAAY,CAC1B,mCAAmC,GACnCE,KAAgB,EAChB,+BAA+B,GAC/BC,YAAe,EACf,SAAS,GACTC,MAA2B,EAC3B;QACA,IAKIA,GAAY,GAAZA,MAAM,IAAI,EAAE,cAAZA,GAAY,CAJdC,QAAQ,EAARA,QAAQ,0BAAG,OAAO,YAAA,qBAIhBD,GAAY,CAHdE,eAAe,EAAfA,eAAe,iCAAG,cAAc,mBAAA,gBAG9BF,GAAY,CAFdG,UAAU,EAAVA,UAAU,4BAAG,UAAU,cAAA,EACvBC,IAAI,GACFJ,GAAY,CADdI,IAAI,AACW;QAEjB,IACE,AAAYC,KAAK,GAGfP,KAAK,CAHNG,QAAQ,CAAQ,EACjB,AAAcK,QAAQ,GAEpBR,KAAK,CAFNK,UAAU,CAAW,EACtB,AAAmBI,gBAAgB,GACjCT,KAAK,CADNI,eAAe,CAAmB,AAC3B;QAEV,yBAAyB;QACzB,IAAMM,QAAQ,GAAGC,IAAAA,MAAM,OAAA,GAAK,AAAC;QAE7B,SAAS;QACT,IAA0BC,IAYxB,kBAZwBA,IAAAA,MAAQ,SAAA,EAAC,WAAM;YACvC,gEAAgE;YAChE,IAAIC,GAAG,GAAGZ,YAAY,AAAC;YACvB,IAAIE,QAAQ,IAAIH,KAAK,EAAE;gBACrBa,GAAG,GAAGb,KAAK,CAACG,QAAQ,CAAC,KAAKW,SAAS,GAAGb,YAAY,GAAGM,KAAK,CAAC;YAC7D,CAAC;YACD,IAAIH,eAAe,IAAIJ,KAAK,EAAE;gBAC5Ba,GAAG,GACDb,KAAK,CAACI,eAAe,CAAC,KAAKU,SAAS,GAAGb,YAAY,GAAGQ,gBAAgB,CAAC;YAC3E,CAAC;YAED,OAAQC,QAAQ,CAACK,OAAO,GAAGF,GAAG,CAAE;QAClC,CAAC,CAAC,IAAA,EAZKG,KAAK,GAAcJ,IAYxB,GAZU,EAAEK,QAAQ,GAAIL,IAYxB,GAZoB,AAYnB;QAEH,aAAa,GACbM,IAAAA,MAAe,gBAAA,EAAC,WAAM;YACpB,IAAIf,QAAQ,IAAIH,KAAK,EAAE;gBACrB,IAAIM,IAAI,EAAE;oBACR,CAACa,IAAAA,QAAQ,QAAA,EAACZ,KAAK,EAAEG,QAAQ,CAACK,OAAO,CAAC,IAChCE,QAAQ,CAAEP,QAAQ,CAACK,OAAO,GAAGR,KAAK,CAAE,CAAC;gBACzC,OAAO;oBACLA,KAAK,KAAKG,QAAQ,CAACK,OAAO,IAAIE,QAAQ,CAAEP,QAAQ,CAACK,OAAO,GAAGR,KAAK,CAAE,CAAC;gBACrE,CAAC;YACH,CAAC;QACH,CAAC,EAAE;YAACA,KAAK;SAAC,CAAC,CAAC;QAEZ,WAAW,GACX,IAAMa,YAAY,GAAyB,SAACC,KAAK,EAAEC,KAAK,EAAK;YAC3D,oDAAoD,GACpD,IAAMC,QAAQ,GAAGpB,QAAQ,IAAIH,KAAK,AAAC;YACnC,IAAIwB,IAAAA,MAAU,WAAA,EAACH,KAAK,CAAC,EAAE;gBACrB,IAAI,CAACE,QAAQ,EAAE;oBACbN,QAAQ,CAAC,SAACQ,IAAI,EAAK;wBACjB,IAAMC,WAAW,GAAGL,KAAK,CAACI,IAAI,CAAC,AAAC;wBAEhCE,IAAAA,MAAK,MAAA,EAAC,WAAM;4BACVnB,QAAQ,IAAIA,QAAQ,CAACkB,WAAW,EAAEJ,KAAK,CAAC,CAAC;wBAC3C,CAAC,CAAC,CAAC;wBAEH,OAAOI,WAAW,CAAC;oBACrB,CAAC,CAAC,CAAC;gBACL,OAAO;oBACL,IAAMA,WAAW,GAAGL,KAAK,CAACX,QAAQ,CAACK,OAAO,CAAE,AAAC;oBAC7CP,QAAQ,IAAIA,QAAQ,CAACkB,WAAW,EAAEJ,KAAK,CAAC,CAAC;gBAC3C,CAAC;YACH,OAAO;gBACLd,QAAQ,IAAIA,QAAQ,CAACa,KAAK,EAAEC,KAAK,CAAC,CAAC;gBACnC,IAAI,CAACC,QAAQ,EAAE;oBACbN,QAAQ,CAACI,KAAK,CAAC,CAAC;gBAClB,CAAC;YACH,CAAC;QACH,CAAC,AAAC;QAEF,OAAO;YAACL,KAAK;YAAEI,YAAY;SAAC,CAAU;IACxC,CAAC"}